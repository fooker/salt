<VirtualHost *:80>
  {% for domain in pillar.web.apps[app].domains -%}
  {% if loop.first -%} ServerName {%- else -%} ServerAlias {%- endif %} {{ domain }}
  {% endfor %}

  RewriteEngine On
  RewriteCond %{HTTPS} !=on
  RewriteRule ^/?(.*) https://%{SERVER_NAME}/$1 [R,L]
</VirtualHost>

<VirtualHost *:443>
  {% for domain in pillar.web.apps[app].domains -%}
  {% if loop.first -%} ServerName {%- else -%} ServerAlias {%- endif %} {{ domain }}
  {% endfor %}

  DocumentRoot /srv/http/wolke

  DirectoryIndex index.php

  <Directory /srv/http/wolke>
    Require all granted

    Options +FollowSymlinks
    AllowOverride All

    <IfModule mod_dav.c>
      Dav off
    </IfModule>

    SetEnv HOME /srv/http/wolke
    SetEnv HTTP_HOME /srv/http/wolke
  </Directory>

  SSLEngine on
  SSLCertificateFile /etc/letsencrypt/domains/wolke.crt
  SSLCertificateKeyFile /etc/letsencrypt/domains.key

  Header always set Strict-Transport-Security "max-age=15768000; includeSubDomains; preload"
</VirtualHost>

