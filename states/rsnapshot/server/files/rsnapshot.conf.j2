### This file is managed by saltstack - any changes will be overwritten ###

config_version	1.2

snapshot_root	/mnt/backups/rsnapshot
no_create_root	1

cmd_cp		/usr/bin/cp
cmd_rm		/usr/bin/rm
cmd_rsync	/usr/bin/rsync
cmd_ssh		/usr/bin/ssh
cmd_logger	/usr/bin/logger
cmd_du		/usr/bin/du

ssh_args	-o BatchMode=yes -o StrictHostKeyChecking=no -a -i /etc/rsnapshot.id

{% for backup in pillar['backup']['retentions'] -%}
retain		{{ backup['id'] }}	{{ backup['count'] }}
{% endfor %}

verbose		2
loglevel	3
logfile		/var/log/rsnapshot

lockfile	/var/run/rsnapshot.pid

link_dest	1
sync_first	1

{% for id in salt['publish.publish']('*', 'grains.get', 'id')|sort() -%}
include_conf	`/usr/bin/ssh -o BatchMode=yes -o StrictHostKeyChecking=no -a -i /etc/rsnapshot.id root@{{ pillar['addresses'][id]['int']['mngt']['ip4'] }} cat /etc/rsnapshot.conf.incl`
{% endfor %}

# Custom targets
backup		backup-replicate@172.23.172.41:/mnt/repos/		maglab

